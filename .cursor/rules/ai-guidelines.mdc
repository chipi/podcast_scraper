# AI Coding Guidelines - Primary Reference

## ‚ö†Ô∏è MANDATORY: Read .ai-coding-guidelines.md First

## üö® START-OF-SESSION CHECKLIST (MANDATORY - DO THIS FIRST)

**Before taking ANY action in this project, you MUST:**

1. ‚úÖ **Read `.ai-coding-guidelines.md`** - This is the PRIMARY source of truth
2. ‚úÖ **Acknowledge you've read it** - Say "I've read the AI guidelines" or similar
3. ‚úÖ **Confirm when asked** - If user asks "Did you read the guidelines?", answer honestly
4. ‚úÖ **Reference it constantly** - For all decisions about code, workflow, and patterns

**If the user asks "Did you read the guidelines?" or "Check the guidelines first":**
- ‚úÖ **STOP what you're doing**
- ‚úÖ **Read `.ai-coding-guidelines.md` immediately**
- ‚úÖ **Acknowledge what you read**
- ‚úÖ **Then proceed with the task**

## üö® CRITICAL: Git Commit Workflow - MANDATORY CHECKLIST

**YOU MUST FOLLOW THIS EXACT SEQUENCE BEFORE EVERY COMMIT:**

### Step-by-Step Commit Process (MANDATORY):

1. **Make code changes** ‚úÖ
2. **MANDATORY: Run `make ci-fast`** - Fast validation before committing (~6-10 min)
   - Runs: formatting, linting, fast tests (unit + fast integration + fast e2e)
   - Pre-commit hook will also run this automatically
3. **If editing markdown:** Run `make fix-md` to auto-fix common issues
4. **Self-check markdown files** (if any were edited):
   - One H1 only, blank lines after headings, no trailing spaces
   - List indentation consistent, code fences have language tags
   - Run `make lint-markdown` to verify
5. **MANDATORY: Run `git status`** - Show user what files changed
6. **MANDATORY: Run `git diff`** - Show user the actual changes
7. **MANDATORY: Wait for explicit approval** - User must say "commit", "yes", "go ahead", etc.
8. **MANDATORY: Get commit message** - User provides message OR you ask for one
9. **THEN commit** - Only after steps 2-8 are complete (pre-commit hook runs additional checks)

### ‚ùå NEVER commit when:
- You haven't run `make ci-fast` first
- You haven't shown `git status` first
- You haven't shown `git diff` first
- User hasn't explicitly approved
- User said "don't commit" or "wait"
- You're assuming approval from context

### ‚úÖ Example CORRECT workflow:
```
AI: I've fixed the issue. Let me run validation first:

[Runs: make ci-fast]
[Shows: All checks passed ‚úì]

Now let me show you what changed:

[Runs: git status]
[Shows: Modified: config.py]

[Runs: git diff config.py]
[Shows: actual diff]

Should I commit these changes?

User: Yes, commit with message "fix: remove duplicate validator"

AI: [Commits with user's message]
```

### ‚ùå Example INCORRECT workflow (DO NOT DO THIS):
```
AI: I've fixed the issue. [Commits immediately without validation or approval]
```

## üö® CRITICAL: PR Push Workflow - MANDATORY CHECKLIST

**YOU MUST FOLLOW THIS EXACT SEQUENCE BEFORE EVERY PUSH TO PR:**

### Step-by-Step Push Process (MANDATORY):

1. **MANDATORY: Show `git status`** - Show user what will be pushed
2. **MANDATORY: Show `git diff` or change summary** - Show user the actual changes
3. **Pre-commit hook has already run** - `make ci-fast` checks passed during commit
4. **MANDATORY: Conditionally run `make docker-test`** - ONLY if Docker-related changes exist (see below)
5. **MANDATORY: Ask user for explicit approval** - User must say "push", "yes", "go ahead", etc.
6. **MANDATORY: Wait for user approval** - DO NOT push until user explicitly approves
7. **THEN push** - Only after steps 1-6 are complete AND user has approved

### When to run `make docker-test` (CONDITIONAL):

**Run `make docker-test` BEFORE pushing to PR ONLY if you made significant changes to:**

- ‚úÖ **Dockerfile** - Any changes to build process, dependencies, or structure
- ‚úÖ **Project structure** - Changes to package layout, subpackages, or file organization
- ‚úÖ **Dependencies** - Changes to `pyproject.toml` that affect Docker installation (core deps, package metadata)
- ‚úÖ **Package configuration** - Changes to `[tool.setuptools]` in `pyproject.toml`

**When NOT to run:**
- ‚ùå Only Python code changes (no Dockerfile or structure changes)
- ‚ùå Only documentation or test file changes
- ‚ùå Only configuration file changes (that don't affect Docker)

### ‚ùå NEVER push to PR when:
- **User hasn't explicitly approved** (MOST IMPORTANT - CHECK THIS FIRST)
- You haven't shown `git status` first
- You haven't shown `git diff` or change summary first
- User said "don't push" or "wait"
- `make docker-test` hasn't been run (when Docker-related changes exist)
- `make docker-test` has failures (when Docker-related changes exist)

### ‚úÖ Example CORRECT push workflow:
```
AI: I've resolved all conflicts and committed changes. Pre-commit hook passed.
Let me show you what will be pushed:

[Runs: git status]
[Shows: Modified files, new files, etc.]

[Runs: git diff --stat]
[Shows: Summary of changes]

Should I push these changes to the PR?

User: Yes, go ahead

AI: [Pushes to PR]
```

### ‚ùå Example INCORRECT push workflow (DO NOT DO THIS):
```
AI: I've resolved all conflicts. [Pushes immediately without showing changes or asking]
```

## üö® CRITICAL: Git Branch Workflow

### NEVER Push Directly to Main

1. ‚ùå **NEVER push directly to main branch** - Even if you have admin permissions
2. ‚úÖ **ALWAYS create a feature branch**: `git checkout -b feat/name`
3. ‚úÖ **ALWAYS push to feature branch, NEVER to main**
4. ‚úÖ **ALWAYS create a PR** for review and merge
5. ‚ö†Ô∏è **"Bypassed rule violations" warning = YOU MADE A MISTAKE**

### Branch Creation Checklist

**BEFORE creating a new branch, check for uncommitted changes:**

```bash
# Step 1: Check current state
git status --porcelain

# If output exists ‚Üí commit, stash, or discard FIRST
# Then create branch from clean state

# Step 2: Create branch from latest main
git checkout main
git pull origin main
git checkout -b feat/new-feature-name
```

## üìã Testing Strategy

### Default: Start with Fast Tests

```bash
# Step 1: Run fast tests (unit + fast integration + fast e2e)
make ci-fast  # ~6-10 min, no coverage overhead
```

### Step 2: Run Slow Tests If Needed

**Run slow tests ONLY if changes touch ML code:**

| Area Changed | Command |
|--------------|---------|
| Whisper integration | `make test-integration-slow` |
| Summarization (ML models) | `make test-integration-slow` |
| Speaker detection (spaCy) | `make test-integration-slow` |
| E2E with ML | `make test-e2e-slow` |
| Both integration + E2E | `make test-all-slow` |

### Step 3: Full Validation (Before Final PR)

```bash
# Complete validation: formatting, linting, tests, docs, build
make ci  # ~10-15 min, includes coverage
```

## üìö Primary Reference

**Quick Reference:** `.cursorrules` (~287 lines) - Always loaded automatically
**Complete Reference:** `.ai-coding-guidelines.md` (~2,310 lines) - Full guidelines

**When user says "load ai coding guidelines":**
- Load `.ai-coding-guidelines.md` for complete reference
- For specific topics:
  - "load testing guide" ‚Üí `docs/guides/TESTING_GUIDE.md`
  - "load markdown guide" ‚Üí `docs/guides/MARKDOWN_LINTING_GUIDE.md`
  - "load cursor guide" ‚Üí `docs/guides/CURSOR_AI_BEST_PRACTICES_GUIDE.md`

## üîß Key Documentation Files

**Essential guides to reference:**

- **`.cursorrules`** - Core project rules (always active)
- **`.ai-coding-guidelines.md`** - Complete AI guidelines (2,310 lines)
- **`docs/guides/DEVELOPMENT_GUIDE.md`** - Technical details (code style, testing, CI/CD)
- **`docs/guides/TESTING_GUIDE.md`** - Test execution, fixtures, coverage
- **`docs/guides/MARKDOWN_LINTING_GUIDE.md`** - Markdown style and linting
- **`docs/guides/CURSOR_AI_BEST_PRACTICES_GUIDE.md`** - Model selection strategies
- **`docs/guides/GIT_WORKTREE_GUIDE.md`** - Git worktree development workflow
- **`docs/ci/index.md`** - CI/CD pipeline documentation
- **`docs/ARCHITECTURE.md`** - System design and module responsibilities

## üéØ Document Location Rules

### CRITICAL: Where to Create Analysis/Plan Documents

**üö® ABSOLUTE RULE:**

- ‚úÖ **ALL analysis/plans/reviews** ‚Üí `docs/wip/` folder
- ‚ùå **NEVER create `docs/analysis/`** - This folder MUST NOT EXIST
- ‚ùå **NEVER create `docs/plan/`** - This folder MUST NOT EXIST

**Examples:**
- ‚úÖ `docs/wip/implementation-plan.md`
- ‚úÖ `docs/wip/code-analysis.md`
- ‚úÖ `docs/wip/architecture-review.md`
- ‚ùå `docs/analysis/anything.md` - FORBIDDEN
- ‚ùå `docs/plan/anything.md` - FORBIDDEN

## üìù Markdown Files

**üö® CRITICAL: When writing or editing markdown files:**

1. **Run `make fix-md`** to auto-fix common issues
2. **Self-check:** One H1, blank lines after headings, no trailing spaces, code fences have languages
3. **Run `make lint-markdown`** to verify
4. **Run `make docs`** to validate build (catches broken links, missing nav)

**See `docs/guides/MARKDOWN_LINTING_GUIDE.md` for complete rules.**

## üöÄ Common Commands

```bash
# Development
make install-hooks    # Install pre-commit hook (one-time)
make format           # Format code (black + isort)
make lint             # Run flake8
make type             # Run mypy
make security         # Run bandit + pip-audit

# Testing
make ci-fast          # Fast tests (~6-10 min)
make test-integration-slow  # Slow integration (~5-10 min)
make test-e2e-slow    # Slow E2E (~15-20 min)
make ci               # Full CI suite (~10-15 min)

# Documentation
make docs             # Build docs (catches broken links)
make lint-markdown    # Check markdown files
make fix-md           # Auto-fix markdown issues

# Docker (conditional)
make docker-test      # Only if changed Dockerfile/structure
```

## ‚ö†Ô∏è REMEMBER

1. NEVER push to main (use feature branches + PRs)
2. ALWAYS show changes and get approval before commit/push
3. ALWAYS run `make ci-fast` before committing
4. Write lint-valid code from the start
5. Respect module boundaries (see `.cursorrules`)
6. Mock external deps in tests
7. Use Config for all runtime options
8. NEVER commit secrets
9. ALL analysis/plans ‚Üí `docs/wip/` (never `docs/analysis/`)
10. Run `make docs` before committing doc changes

**When in doubt, check `.ai-coding-guidelines.md` or `.cursorrules` for details.**

---

**Version:** 2.0
**Updated:** 2026-01-07
**Source:** Aligned with `.cursorrules` and latest `.ai-coding-guidelines.md`
