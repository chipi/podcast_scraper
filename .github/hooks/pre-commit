#!/bin/bash
#
# Git pre-commit hook to check linting before commits
# 
# This hook runs checks ONLY on staged files:
# - Black & isort formatting checks (Python files)
# - flake8 linting (Python files)
# - markdownlint on markdown files
# - JSON syntax validation (JSON files)
# - YAML syntax validation (YAML/YML files)
# - mypy type checking (Python files)
#
# To install: run `make install-hooks` or manually:
#   cp .github/hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# To skip the hook for a specific commit:
#   git commit --no-verify

set -e

echo "ğŸ” Running pre-commit checks on staged files..."
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

ERRORS=0

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${YELLOW}âš ${NC} No staged files to check"
    exit 0
fi

# Filter staged files by type
STAGED_PYTHON=$(echo "$STAGED_FILES" | grep -E '\.(py)$' || true)
STAGED_MARKDOWN=$(echo "$STAGED_FILES" | grep -E '\.(md)$' || true)
STAGED_JSON=$(echo "$STAGED_FILES" | grep -E '\.(json)$' || true)
STAGED_YAML=$(echo "$STAGED_FILES" | grep -E '\.(yaml|yml)$' || true)

# Function to run a check and track errors
run_check() {
    local name="$1"
    local command="$2"
    
    echo "â†’ Running $name..."
    if eval "$command" > /tmp/precommit_$$.log 2>&1; then
        echo -e "${GREEN}âœ“${NC} $name passed"
    else
        echo -e "${RED}âœ—${NC} $name failed"
        cat /tmp/precommit_$$.log
        ERRORS=$((ERRORS + 1))
    fi
    rm -f /tmp/precommit_$$.log
    echo ""
}

# Check if there are any Python files to check
if [ -n "$STAGED_PYTHON" ]; then
    # Convert newline-separated list to space-separated for commands
    PYTHON_FILES=$(echo "$STAGED_PYTHON" | tr '\n' ' ')
    
    # Check formatting on staged Python files
    run_check "Black formatting" "black --check $PYTHON_FILES"
    run_check "isort import sorting" "isort --check-only $PYTHON_FILES"
    
    # Check linting on staged Python files
    # E9: runtime errors, F63: print statements, F7: syntax errors, F82: undefined names, E501: line too long
    run_check "flake8 linting" "flake8 --config .flake8 $PYTHON_FILES --count --select=E9,F63,F7,F82,E501 --show-source --statistics"
    
    # Check types on staged Python files
    # Note: mypy works better when checking the whole project, but we can check specific files
    # For better accuracy, we'll check the whole project but only report errors in staged files
    echo "â†’ Running mypy type checking..."
    if mypy --config-file pyproject.toml . > /tmp/precommit_mypy_$$.log 2>&1; then
        echo -e "${GREEN}âœ“${NC} mypy type checking passed"
    else
        # Filter mypy output to only show errors for staged files
        FILTERED_ERRORS=$(grep -f <(echo "$STAGED_PYTHON" | sed 's|^|^|' | sed 's|$|:|') /tmp/precommit_mypy_$$.log || true)
        if [ -n "$FILTERED_ERRORS" ]; then
            echo -e "${RED}âœ—${NC} mypy type checking failed (errors in staged files)"
            echo "$FILTERED_ERRORS"
            ERRORS=$((ERRORS + 1))
        else
            echo -e "${GREEN}âœ“${NC} mypy type checking passed (no errors in staged files)"
        fi
    fi
    rm -f /tmp/precommit_mypy_$$.log
    echo ""
else
    echo -e "${YELLOW}âš ${NC} No Python files staged, skipping Python checks"
    echo ""
fi

# Check markdown linting (required when markdown files are staged)
if [ -n "$STAGED_MARKDOWN" ]; then
    if command -v markdownlint >/dev/null 2>&1; then
        MARKDOWN_FILES=$(echo "$STAGED_MARKDOWN" | tr '\n' ' ')
        run_check "Markdown linting" "markdownlint $MARKDOWN_FILES --ignore node_modules --ignore .venv --ignore .build"
    else
        echo -e "${RED}âœ—${NC} markdownlint not found but markdown files are staged"
        echo ""
        echo "Markdown linting is required when committing markdown files."
        echo "Install markdownlint with:"
        echo "  npm install -g markdownlint-cli"
        echo ""
        echo "Or skip this check with: git commit --no-verify"
        echo ""
        ERRORS=$((ERRORS + 1))
    fi
else
    echo -e "${YELLOW}âš ${NC} No markdown files staged, skipping markdown checks"
    echo ""
fi

# Check JSON syntax validation (required when JSON files are staged)
if [ -n "$STAGED_JSON" ]; then
    echo "â†’ Running JSON syntax validation..."
    JSON_ERRORS=0
    for json_file in $STAGED_JSON; do
        if python3 -m json.tool "$json_file" > /dev/null 2>&1; then
            echo -e "  ${GREEN}âœ“${NC} $json_file"
        else
            echo -e "  ${RED}âœ—${NC} $json_file"
            python3 -m json.tool "$json_file" 2>&1 | head -5
            JSON_ERRORS=$((JSON_ERRORS + 1))
        fi
    done
    if [ $JSON_ERRORS -eq 0 ]; then
        echo -e "${GREEN}âœ“${NC} JSON syntax validation passed"
    else
        echo -e "${RED}âœ—${NC} JSON syntax validation failed ($JSON_ERRORS file(s) with errors)"
        ERRORS=$((ERRORS + 1))
    fi
    echo ""
else
    echo -e "${YELLOW}âš ${NC} No JSON files staged, skipping JSON checks"
    echo ""
fi

# Check YAML syntax validation (required when YAML files are staged)
if [ -n "$STAGED_YAML" ]; then
    echo "â†’ Running YAML syntax validation..."
    YAML_ERRORS=0
    for yaml_file in $STAGED_YAML; do
        # Try yamllint first if available (better error messages and handles custom tags)
        if command -v yamllint >/dev/null 2>&1; then
            if yamllint "$yaml_file" > /tmp/precommit_yaml_$$.log 2>&1; then
                echo -e "  ${GREEN}âœ“${NC} $yaml_file"
            else
                echo -e "  ${RED}âœ—${NC} $yaml_file"
                cat /tmp/precommit_yaml_$$.log | head -5
                YAML_ERRORS=$((YAML_ERRORS + 1))
            fi
            rm -f /tmp/precommit_yaml_$$.log
        else
            # Fallback to Python yaml module - check basic syntax (ignore custom tags)
            # Use a custom loader that ignores unknown tags for basic syntax validation
            if python3 -c "
import yaml
import sys
try:
    with open('$yaml_file', 'r') as f:
        # Try to parse YAML - if it fails, it's a syntax error
        list(yaml.safe_load_all(f))
    sys.exit(0)
except yaml.YAMLError as e:
    # Only fail on actual YAML syntax errors, not unknown tags
    if 'could not determine a constructor' in str(e) or 'tag:' in str(e):
        # Unknown tag - this is OK for syntax validation
        sys.exit(0)
    else:
        # Real syntax error
        print(e, file=sys.stderr)
        sys.exit(1)
except Exception as e:
    print(e, file=sys.stderr)
    sys.exit(1)
" > /tmp/precommit_yaml_$$.log 2>&1; then
                echo -e "  ${GREEN}âœ“${NC} $yaml_file"
            else
                echo -e "  ${RED}âœ—${NC} $yaml_file"
                cat /tmp/precommit_yaml_$$.log | head -5
                YAML_ERRORS=$((YAML_ERRORS + 1))
            fi
            rm -f /tmp/precommit_yaml_$$.log
        fi
    done
    if [ $YAML_ERRORS -eq 0 ]; then
        echo -e "${GREEN}âœ“${NC} YAML syntax validation passed"
    else
        echo -e "${RED}âœ—${NC} YAML syntax validation failed ($YAML_ERRORS file(s) with errors)"
        ERRORS=$((ERRORS + 1))
    fi
    echo ""
else
    echo -e "${YELLOW}âš ${NC} No YAML files staged, skipping YAML checks"
    echo ""
fi

# Summary
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
if [ $ERRORS -eq 0 ]; then
    echo -e "${GREEN}âœ“ All pre-commit checks passed!${NC}"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    exit 0
else
    echo -e "${RED}âœ— $ERRORS check(s) failed!${NC}"
    echo ""
    echo "Fix the issues above or use:"
    echo "  â€¢ make format       - Auto-fix formatting"
    echo "  â€¢ git commit --no-verify - Skip checks (not recommended)"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    exit 1
fi
