name: Docker Build & Test

on:
  push:
    branches: [ "main", "release/2.4" ]
    paths:
      - 'Dockerfile'
      - '.dockerignore'
      - 'pyproject.toml'
      - '**.py'
  # Fast Docker build runs on PRs when Docker-related files change
  # Full Docker validation still runs on merge to main
  pull_request:
    branches: [ "main", "release/2.4" ]
    paths:
      - 'Dockerfile'
      - '.dockerignore'
      - 'pyproject.toml'
      - '**.py'

permissions:
  contents: read

jobs:
  # Fast Docker build for PRs (LLM-only variant, sub-3 min target)
  # Builds LLM-only variant for fast feedback on PRs
  # Most code changes affect both variants, so LLM-only is sufficient for PR validation
  docker-build-fast:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6

    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /home/linuxbrew/.linuxbrew
        docker image prune -af || true
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        df -h

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: |
          image=moby/buildkit:latest

    - name: Build Docker image (LLM-only variant, fast)
      uses: docker/build-push-action@v6
      with:
        context: .
        file: Dockerfile
        build-args: |
          INSTALL_EXTRAS=
        push: false
        load: true
        tags: podcast-scraper:test-llm
        cache-from: type=gha,scope=llm-only
        cache-to: type=gha,mode=max,scope=llm-only

    - name: Test Docker image (help command)
      run: |
        docker run --rm podcast-scraper:test-llm --help

    - name: Test Docker image (version check)
      run: |
        docker run --rm podcast-scraper:test-llm --version

    - name: Test Docker image (no args - should show config file error)
      run: |
        output=$(docker run --rm podcast-scraper:test-llm 2>&1 || true)
        echo "$output" | grep -q "Config file not found"

    - name: Validate Dockerfile with hadolint
      run: |
        docker run --rm -v $(pwd):/workspace -w /workspace hadolint/hadolint:latest hadolint Dockerfile

  # Full Docker build for main branch (both variants in parallel)
  # Builds both LLM-only and ML-enabled variants to ensure full validation
  docker-build-full:
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/release/2.4')
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: llm-only
            tag: podcast-scraper:test-llm
            build_args: "INSTALL_EXTRAS="
          - name: ml
            tag: podcast-scraper:test
            build_args: "INSTALL_EXTRAS=ml\nPRELOAD_ML_MODELS=true\nWHISPER_MODELS=base.en"
    steps:
    - uses: actions/checkout@v6

    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /home/linuxbrew/.linuxbrew
        docker image prune -af || true
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        df -h

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: |
          image=moby/buildkit:latest

    - name: Build Docker image (${{ matrix.name }})
      uses: docker/build-push-action@v6
      with:
        context: .
        file: Dockerfile
        build-args: |
          ${{ matrix.build_args }}
        push: false
        load: true
        tags: ${{ matrix.tag }}
        cache-from: type=gha,scope=${{ matrix.name }}
        cache-to: type=gha,mode=max,scope=${{ matrix.name }}

    - name: Test Docker image (${{ matrix.name }} - help command)
      run: |
        docker run --rm ${{ matrix.tag }} --help

    - name: Test Docker image (${{ matrix.name }} - version check)
      run: |
        docker run --rm ${{ matrix.tag }} --version

    - name: Test Docker image (${{ matrix.name }} - no args - should show config file error)
      run: |
        output=$(docker run --rm ${{ matrix.tag }} 2>&1 || true)
        echo "$output" | grep -q "Config file not found"

    - name: Validate Dockerfile with hadolint
      if: matrix.name == 'llm-only'
      run: |
        docker run --rm -v $(pwd):/workspace -w /workspace hadolint/hadolint:latest hadolint Dockerfile
