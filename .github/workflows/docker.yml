name: Docker Build & Test

on:
  push:
    branches: [ "main" ]
    paths:
      - 'Dockerfile'
      - '.dockerignore'
      - 'pyproject.toml'
      - '*.py'
  # Docker build on PRs only when Dockerfile/.dockerignore change
  # This speeds up PRs by skipping Docker builds for Python-only changes
  # Full Docker validation still runs on merge to main
  pull_request:
    branches: [ "main" ]
    paths:
      - 'Dockerfile'
      - '.dockerignore'

permissions:
  contents: read

jobs:
  # Fast Docker build for PRs (sub-5 min target)
  docker-build-fast:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /home/linuxbrew/.linuxbrew
        docker image prune -af || true
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        df -h

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: |
          image=moby/buildkit:latest

    - name: Build Docker image (default, skip model preloading)
      uses: docker/build-push-action@v5
      with:
        context: .
        file: Dockerfile
        build-args: |
          WHISPER_PRELOAD_MODELS=
        push: false
        load: true
        tags: podcast-scraper:test
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Test Docker image (help command)
      run: |
        docker run --rm podcast-scraper:test --help

    - name: Test Docker image (version check)
      run: |
        docker run --rm podcast-scraper:test --version

    - name: Test Docker image (no args - should show error)
      run: |
        output=$(docker run --rm podcast-scraper:test 2>&1 || true)
        echo "$output" | grep -q "required"

    - name: Validate Dockerfile with hadolint
      run: |
        docker run --rm -v $(pwd):/workspace -w /workspace hadolint/hadolint:latest hadolint Dockerfile

  # Full Docker build for main branch
  docker-build-full:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /home/linuxbrew/.linuxbrew
        docker image prune -af || true
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        df -h

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: |
          image=moby/buildkit:latest

    - name: Build Docker image (default)
      uses: docker/build-push-action@v5
      with:
        context: .
        file: Dockerfile
        push: false
        load: true
        tags: podcast-scraper:test
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build Docker image (multiple models)
      uses: docker/build-push-action@v5
      with:
        context: .
        file: Dockerfile
        build-args: |
          WHISPER_PRELOAD_MODELS=tiny.en,base.en
        push: false
        load: true
        tags: podcast-scraper:multi-model
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Test Docker image (help command)
      run: |
        docker run --rm podcast-scraper:test --help

    - name: Test Docker image (version check)
      run: |
        docker run --rm podcast-scraper:test --version

    - name: Test Docker image (no args - should show error)
      run: |
        output=$(docker run --rm podcast-scraper:test 2>&1 || true)
        echo "$output" | grep -q "required"

    - name: Validate Dockerfile with hadolint
      run: |
        docker run --rm -v $(pwd):/workspace -w /workspace hadolint/hadolint:latest hadolint Dockerfile
