# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: Python application

on:
  push:
    branches: [ "main" ]
    paths:
      - '**.py'
      - 'tests/**'
      - 'pyproject.toml'
      - 'Makefile'
      - 'docker/**'
  pull_request:
    branches: [ "main" ]
    paths:
      - '**.py'
      - 'tests/**'
      - 'pyproject.toml'
      - 'Makefile'
      - 'docker/**'

permissions:
  contents: read

jobs:
  # Fast checks - no heavy ML dependencies
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: "pip"
        cache-dependency-path: pyproject.toml
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: "20"
    - name: Install lint dependencies (no ML packages)
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]
    - name: Install markdownlint
      run: npm install -g markdownlint-cli
    - name: Run lint checks
      run: |
        export PYTHONPATH="${PYTHONPATH}:$(pwd)"
        make format-check
        make lint
        make lint-markdown
        make type
        make security

  # Unit tests - fast, no ML dependencies, network isolation enforced
  test-unit:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: "pip"
        cache-dependency-path: pyproject.toml
    - name: Install dev dependencies (no ML)
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]
    - name: Verify unit tests can import without ML dependencies
      run: |
        export PYTHONPATH="${PYTHONPATH}:$(pwd)"
        python scripts/check_unit_test_imports.py
      env:
        PACKAGE: podcast_scraper
    - name: Run unit tests (network isolation enforced, parallel execution)
      run: |
        export PYTHONPATH="${PYTHONPATH}:$(pwd)"
        # Run tests and capture output
        OUTPUT=$(pytest tests/unit/ -v --tb=short -n auto 2>&1)
        echo "$OUTPUT"
        # Verify tests were collected and run
        if echo "$OUTPUT" | grep -q "no tests collected"; then
          echo "ERROR: No tests were collected!"
          exit 1
        fi
        # Verify minimum test count (unit tests should have many tests)
        TEST_COUNT=$(echo "$OUTPUT" | grep -oP "(\d+) passed" | head -1 | grep -oP "\d+" || echo "0")
        if [ "$TEST_COUNT" -lt 50 ]; then
          echo "ERROR: Only $TEST_COUNT tests passed, expected at least 50 unit tests"
          exit 1
        fi
    - name: Verify network isolation
      run: |
        export PYTHONPATH="${PYTHONPATH}:$(pwd)"
        pytest tests/unit/test_network_isolation.py -v
      env:
        PACKAGE: podcast_scraper

  # Integration tests - needs ML dependencies
  test-integration:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /home/linuxbrew/.linuxbrew
        docker image prune -af || true
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        df -h
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: "pip"
        cache-dependency-path: pyproject.toml
    - name: Install full dependencies (including ML)
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev,ml]
    - name: Run integration tests (parallel execution, with reruns for flaky tests)
      run: |
        export PYTHONPATH="${PYTHONPATH}:$(pwd)"
        # Run tests and capture output
        OUTPUT=$(pytest tests/integration/ -v -m integration -n auto --reruns 2 --reruns-delay 1 2>&1)
        echo "$OUTPUT"
        # Verify tests were collected and run
        if echo "$OUTPUT" | grep -q "no tests collected"; then
          echo "ERROR: No tests were collected!"
          exit 1
        fi
        # Verify at least some tests passed
        if echo "$OUTPUT" | grep -q "passed = 0"; then
          echo "ERROR: No tests passed!"
          exit 1
        fi
        # Verify minimum test count (integration tests should have many tests)
        TEST_COUNT=$(echo "$OUTPUT" | grep -oP "(\d+) passed" | head -1 | grep -oP "\d+" || echo "0")
        if [ "$TEST_COUNT" -lt 10 ]; then
          echo "ERROR: Only $TEST_COUNT tests passed, expected at least 10 integration tests"
          exit 1
        fi
    - name: Post-build cleanup
      if: always()
      run: |
        rm -rf ~/.cache/huggingface ~/.cache/torch ~/.cache/whisper
        rm -rf .pytest_cache .mypy_cache .build dist

  # Workflow E2E tests - needs ML dependencies, runs on main branch only
  test-workflow-e2e:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4
    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /home/linuxbrew/.linuxbrew
        docker image prune -af || true
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        df -h
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: "pip"
        cache-dependency-path: pyproject.toml
    - name: Install full dependencies (including ML)
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev,ml]
    - name: Run workflow E2E tests (parallel execution, with reruns for flaky tests)
      run: |
        export PYTHONPATH="${PYTHONPATH}:$(pwd)"
        # Run tests and capture output
        OUTPUT=$(pytest tests/workflow_e2e/ -v -m workflow_e2e -n auto --reruns 2 --reruns-delay 1 2>&1)
        echo "$OUTPUT"
        # Verify tests were collected and run
        if echo "$OUTPUT" | grep -q "no tests collected"; then
          echo "ERROR: No tests were collected!"
          exit 1
        fi
        # Verify at least some tests passed
        if echo "$OUTPUT" | grep -q "passed = 0"; then
          echo "ERROR: No tests passed!"
          exit 1
        fi
        # Verify minimum test count (workflow_e2e tests should have many tests)
        TEST_COUNT=$(echo "$OUTPUT" | grep -oP "(\d+) passed" | head -1 | grep -oP "\d+" || echo "0")
        if [ "$TEST_COUNT" -lt 5 ]; then
          echo "ERROR: Only $TEST_COUNT tests passed, expected at least 5 workflow_e2e tests"
          exit 1
        fi
    - name: Post-build cleanup
      if: always()
      run: |
        rm -rf ~/.cache/huggingface ~/.cache/torch ~/.cache/whisper
        rm -rf .pytest_cache .mypy_cache .build dist

  # Full test suite - runs all tests (for PRs, includes unit + integration)
  test:
    runs-on: ubuntu-latest
    needs: [test-unit, test-integration]
    if: github.event_name == 'pull_request'
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: "pip"
        cache-dependency-path: pyproject.toml
    - name: Install full dependencies (including ML)
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev,ml]
    - name: Run all tests (unit + integration, parallel execution)
      run: |
        export PYTHONPATH="${PYTHONPATH}:$(pwd)"
        # Run tests and capture output
        OUTPUT=$(pytest tests/unit/ tests/integration/ -v --cov=podcast_scraper --cov-report=term-missing -n auto 2>&1)
        echo "$OUTPUT"
        # Verify tests were collected and run
        if echo "$OUTPUT" | grep -q "no tests collected"; then
          echo "ERROR: No tests were collected!"
          exit 1
        fi
        # Verify minimum test count (should have many tests from both unit and integration)
        TEST_COUNT=$(echo "$OUTPUT" | grep -oP "(\d+) passed" | head -1 | grep -oP "\d+" || echo "0")
        if [ "$TEST_COUNT" -lt 60 ]; then
          echo "ERROR: Only $TEST_COUNT tests passed, expected at least 60 tests (unit + integration)"
          exit 1
        fi
      env:
        PACKAGE: podcast_scraper
    - name: Post-build cleanup
      if: always()
      run: |
        rm -rf ~/.cache/huggingface ~/.cache/torch ~/.cache/whisper
        rm -rf .pytest_cache .mypy_cache .build dist

  # Documentation build
  docs:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: "pip"
        cache-dependency-path: |
          docs/requirements.txt
          pyproject.toml
    - name: Install doc dependencies (includes ML for mkdocstrings)
      run: |
        python -m pip install --upgrade pip
        pip install -r docs/requirements.txt
        pip install -e .[ml]
    - name: Build docs
      run: make docs

  # Build package
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: "pip"
    - name: Install build tools
      run: |
        python -m pip install --upgrade pip
        pip install build
    - name: Build package
      run: make build
