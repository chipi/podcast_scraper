name: Deploy MkDocs Documentation

on:
  push:
    branches:
      - main
      # Note: Only deploy from main as "latest" documentation
      # Release branches (release/2.4) are for stabilization and may contain
      # unstable changes. Production docs should reference the tagged release.
    paths:
      # Only files that are part of the MkDocs site (see mkdocs.yml nav)
      - 'docs/index.md'
      - 'docs/ARCHITECTURE.md'
      - 'docs/TESTING_STRATEGY.md'
      - 'docs/CI_CD.md'
      - 'docs/legal.md'
      - 'docs/api/**'
      - 'docs/guides/**'
      - 'docs/prd/**'
      - 'docs/rfc/**'
      - 'docs/releases/**'
      - 'docs/wip/**'
      - 'docs/javascripts/**'
      - 'mkdocs.yml'
      - '**.py'  # Python files for API docs (mkdocstrings)
      - 'README.md'
  pull_request:
    branches: [ "main", "release/2.4" ]
    # PRs can still be tested against both branches, but only main deploys
    paths:
      # Only files that are part of the MkDocs site (see mkdocs.yml nav)
      - 'docs/index.md'
      - 'docs/ARCHITECTURE.md'
      - 'docs/TESTING_STRATEGY.md'
      - 'docs/CI_CD.md'
      - 'docs/legal.md'
      - 'docs/api/**'
      - 'docs/guides/**'
      - 'docs/prd/**'
      - 'docs/rfc/**'
      - 'docs/releases/**'
      - 'docs/wip/**'
      - 'docs/javascripts/**'
      - 'mkdocs.yml'
      - '**.py'  # Python files for API docs (mkdocstrings)
      - 'README.md'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write
  actions: read  # Required to download artifacts from other workflows

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: docs/requirements.txt

      - name: Install documentation dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r docs/requirements.txt
          pip install -e .

      - name: Build MkDocs site
        run: |
          export PYTHONPATH="${PYTHONPATH}:$(pwd)"
          # Generate deployment metadata
          DEPLOY_TIME=$(date -u +"%Y-%m-%d %H:%M UTC")
          DEPLOY_BRANCH="${{ github.ref_name }}"
          DEPLOY_SHA="${{ github.sha }}"
          DEPLOY_SHA_SHORT="${DEPLOY_SHA:0:7}"
          DEPLOY_URL="https://github.com/${{ github.repository }}/commit/${DEPLOY_SHA}"

          # Create deploy-info.json
          mkdir -p .build/site
          cat > .build/site/deploy-info.json << EOF
          {
            "timestamp": "${DEPLOY_TIME}",
            "branch": "${DEPLOY_BRANCH}",
            "commit": "${DEPLOY_SHA_SHORT}",
            "commitUrl": "${DEPLOY_URL}"
          }
          EOF

          mkdocs build --strict

      - name: Download latest metrics from CI workflow
        if: github.event_name == 'push'
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: python-app.yml
          name: metrics
          path: .build/site/metrics
          if_no_artifact_found: warn
          search_artifacts: true
        continue-on-error: true

      - name: Download latest metrics from nightly workflow
        if: github.event_name == 'push'
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: nightly.yml
          name: nightly-metrics
          path: .build/site/metrics/nightly
          if_no_artifact_found: warn
          search_artifacts: true
        continue-on-error: true

      - name: Create metrics landing page if metrics exist
        if: github.event_name == 'push'
        run: |
          mkdir -p .build/site/metrics

          # Check if CI metrics were downloaded
          if [ -f ".build/site/metrics/index.html" ]; then
            echo "âœ… CI metrics dashboard available at /metrics/"
          else
            echo "âš ï¸ No CI metrics found, creating placeholder"
            cat > .build/site/metrics/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Metrics Dashboard</title>
            <style>
              body { font-family: system-ui, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
              h1 { color: #333; }
              p { color: #666; line-height: 1.6; }
              a { color: #0066cc; }
              .links { margin-top: 20px; }
              .links a { display: block; margin: 10px 0; }
            </style>
          </head>
          <body>
            <h1>ğŸ“Š Metrics Dashboard</h1>
            <p>No CI metrics data available yet.</p>
            <p>Metrics are generated after CI runs on the main branch.</p>
            <div class="links">
              <a href="nightly/">ğŸ“… Nightly Metrics</a>
              <a href="/">â† Back to Documentation</a>
            </div>
          </body>
          </html>
          EOF
          fi

          # Check if nightly metrics were downloaded
          if [ -d ".build/site/metrics/nightly" ] && [ -f ".build/site/metrics/nightly/index.html" ]; then
            echo "âœ… Nightly metrics available at /metrics/nightly/"
          else
            echo "âš ï¸ No nightly metrics found, creating placeholder"
            mkdir -p .build/site/metrics/nightly
            cat > .build/site/metrics/nightly/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Nightly Metrics</title>
            <style>
              body { font-family: system-ui, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
              h1 { color: #333; }
              p { color: #666; }
              a { color: #0066cc; }
            </style>
          </head>
          <body>
            <h1>ğŸ“… Nightly Metrics</h1>
            <p>No nightly metrics data available yet.</p>
            <p>Nightly metrics are generated from scheduled nightly test runs.</p>
            <p><a href="../">â† Back to Metrics</a> | <a href="/">â† Back to Documentation</a></p>
          </body>
          </html>
          EOF
          fi

      - name: Upload artifact
        if: github.event_name == 'push'
        uses: actions/upload-pages-artifact@v3
        with:
          path: .build/site

  deploy:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
