# Cursor Rules for podcast_scraper

## üö® CRITICAL RULES (ALWAYS ENFORCE - NO EXCEPTIONS)

### Git & Branch Workflow

0. **NEVER push any branch unless the user explicitly asks**
   - Do not push to main or feature branches without explicit user instruction
   - Commits are allowed after user approves the diff; pushes are never allowed by default
   - Always pause and ask before any push action, even if tests are green

1. **NEVER push directly to main branch**
   - ALWAYS create feature branch: `git checkout -b feat/name`
   - ALWAYS push to feature branch, NEVER to main
   - Even with admin permissions, NEVER bypass this rule
   - "Bypassed rule violations" warning = YOU MADE A MISTAKE

2. **NEVER commit without explicit user approval**
   - MUST run: `git status` ‚Üí `git diff` ‚Üí show user ‚Üí wait for approval ‚Üí THEN commit
   - NEVER skip showing changes first
   - NEVER assume approval
   - Get commit message from user OR ask for one

3. **NEVER push to PR without explicit user approval**
   - MUST run: `git status` ‚Üí `git diff` ‚Üí show changes ‚Üí wait for "yes"/"push"/"go ahead" ‚Üí THEN push
   - NEVER push without showing what you're pushing
   - Pre-commit hook runs `make ci-fast`, so can push directly after it passes

4. **ALWAYS check for uncommitted changes before creating branch**
   - Run `git status --porcelain` first
   - If output exists ‚Üí commit, stash, or discard before creating branch
   - Prevents accidentally including unrelated changes in new branch

### Testing & Validation

5. **ALWAYS run `make ci-fast` before committing** (~6-10 min)
   - Fast tests: unit + fast integration + fast e2e
   - Catches issues early
   - Pre-commit hook will also run this automatically

6. **Run slow tests if changes touch ML code**
   - Changed ML model code? ‚Üí Run `make test-integration-slow` or `make test-e2e-slow`
   - Changed `whisper_integration.py`, `summarizer.py`, `speaker_detection.py`? ‚Üí Run slow tests
   - Changed `workflow.py` with ML? ‚Üí Run `make test-all-slow`

7. **CONDITIONALLY run `make docker-test` before commit**
   - ONLY if changed: Dockerfile, pyproject.toml structure, package layout
   - Skip for: Python code only, docs only, tests only
   - Prevents Docker CI failures

7a. **ALWAYS use Makefile commands, NEVER direct pytest/python commands**
   - ‚úÖ Good: `make test`, `make test-unit`, `make ci`
   - ‚ùå Bad: `pytest`, `python3 -m pytest`, `python test.py`
   - ‚úÖ Good: `make format`, `make lint`
   - ‚ùå Bad: `black .`, `flake8`, `mypy`
   - Why: Makefile uses worktree-specific `.venv/bin/python3`, preventing cross-contamination
   - Exception: `git` commands are safe (not Python-related)
   - If you must run Python directly: `.venv/bin/python3 script.py`

### Terminal Command Execution

8. **ALWAYS show terminal output for make commands and tests**
   - Use `is_background: false` for ALL `make` commands
   - Use `is_background: false` for ALL test commands (pytest, etc.)
   - Use `is_background: false` for validation commands (lint, format, type check)
   - User wants to see output immediately, not in expandable section
   - ONLY use `is_background: true` for long-running servers/daemons
   - Examples requiring immediate output:
     - `make test`, `make ci`, `make ci-fast`
     - `make lint`, `make format`, `make type`
     - `make docs`, `make fix-md`
     - `pytest`, `python -m pytest`
     - `git status`, `git diff`

8a. **NEVER use `cd` to project root before commands**
   - Terminal is ALREADY in project root (workspace directory)
   - Run commands directly: `make test` (NOT `cd /path && make test`)
   - Exception: Only use `cd` when navigating to subdirectories
   - Examples:
     - ‚úÖ Good: `make docs`
     - ‚ùå Bad: `cd /path/to/project && make docs`
     - ‚úÖ Good (subdirectory): `cd scripts && python analyze.py`

### Documentation & Markdown

9. **Run `make fix-md` before committing markdown files**
   - Fixes: tables, trailing spaces, blank lines, code block languages
   - Then self-check: one H1, blank lines after headings, no trailing spaces, consistent lists, code fences have languages

9a. **When creating or editing markdown, lint/format immediately with our tools**
    - Run `make fix-md` / `make lint-markdown` immediately after any doc/markdown edit
    - Do NOT leave lint errors for follow-up; ensure zero markdown lint violations before asking for review
    - This avoids lint churn and ensures clean commits from the start
    - Apply during the edit, not later

10. **ALWAYS run `make docs` to validate docs build**
   - Catches: broken links, missing nav entries, invalid references
   - Required before committing doc changes

11. **NEVER create `docs/analysis/` or `docs/plan/` folders**
    - ALL analysis/plans/reviews ‚Üí `docs/wip/` folder
    - Examples: `docs/wip/implementation-plan.md`, `docs/wip/code-analysis.md`
    - This is ABSOLUTE - no exceptions

### Code Quality

12. **Write lint-valid code from the start**
    - Lines < 100 chars (break long lines)
    - Imports organized (stdlib ‚Üí third-party ‚Üí local)
    - Remove unused imports/variables
    - Add type hints to function signatures
    - Add docstrings (Google-style) to public functions

13. **Use MCP GitHub server for GitHub operations**
    - Preferred: `mcp_github_*` tools (PRs, issues, branches)
    - Fallback: GitHub API only if MCP fails
    - NEVER use raw API when MCP available

14. **ALWAYS use correct GitHub username, NOT Mac username**
    - Mac username (from file paths) may differ from GitHub username
    - GitHub username: Use `mcp_github_get_me` tool to get current user's GitHub login
    - NEVER hardcode usernames - always check dynamically
    - Example: Call `mcp_github_get_me` ‚Üí use `login` field from response
    - This prevents using Mac username when GitHub username is needed

## üìã PROJECT CONTEXT

### What This Project Is

Python tool for podcast transcript downloading/generation:
- Download transcripts from RSS feeds
- Fallback to Whisper transcription
- Speaker detection (spaCy NER)
- Summarization (BART/LED or OpenAI)
- Metadata generation (JSON/YAML)

### Tech Stack

- Python 3.10+ with Pydantic v2
- pytest (testing), black/isort/flake8/mypy (linting)
- MkDocs (docs), Whisper (transcription), transformers (ML)
- OpenAI API (optional provider)

### Module Boundaries (STRICT - DO NOT MIX)

- `cli.py` ‚Üí CLI only (no business logic, HTTP, file I/O)
- `service.py` ‚Üí Service API only (no CLI interaction)
- `workflow.py` ‚Üí Orchestration only (no HTTP, parsing, direct I/O)
- `config.py` ‚Üí Configuration model only (no side effects)
- `downloader.py` ‚Üí HTTP only (no parsing, business logic)
- `rss_parser.py` ‚Üí RSS parsing only (no HTTP, file I/O)

## üéØ CODING STANDARDS

### Imports (isort-compatible)

```python
# Group 1: stdlib
import os
from pathlib import Path

# Group 2: third-party
import requests
from pydantic import BaseModel

# Group 3: local
from podcast_scraper import config
from podcast_scraper.models import Episode
```

### Lazy Loading Pattern

- `__init__.py` uses lazy loading to prevent circular imports
- Access modules via `from podcast_scraper import cli, service`
- When adding new modules, update `__getattr__` in `__init__.py`

### Configuration Pattern

- ALL runtime options go in `Config` model
- No scattered parameters across functions
- Pydantic validation ensures type safety

### Error Handling

- Recoverable errors ‚Üí log warning, return None, continue
- Fatal errors ‚Üí raise appropriate exception with context
- Optional deps ‚Üí try/except ImportError with helpful message

### Testing Requirements

- Mock external deps: Whisper, HTTP, file I/O, spaCy, time operations
- Use pytest markers: `@pytest.mark.slow`, `@pytest.mark.integration`, `@pytest.mark.ml_models`
- Test names: `test_<function>_<scenario>` (descriptive)
- Coverage target: >80%

### Docstrings (Google-style)

```python
def function(arg: Type) -> ReturnType:
    """One-line summary.

    Longer description if needed.

    Args:
        arg: Description.

    Returns:
        Description of return value.

    Raises:
        ErrorType: When this happens.

    Example:
        >>> result = function(value)
    """
```

### Logging (NOT print)

```python
import logging
logger = logging.getLogger(__name__)

# Use structured logging with context
logger.info(f"Processing episode {episode.number}: {episode.title}")
logger.warning(f"Failed to download: {error}")
logger.error(f"Pipeline failed: {error}", exc_info=True)

# NEVER use print() statements
```

## üìö DOCUMENTATION RULES

### When to Create PRD/RFC

- **PRD** ‚Üí User-facing features, significant additions, workflow changes
- **RFC** ‚Üí Architecture changes, breaking API changes, design decisions
- **Skip** ‚Üí Bug fixes, small enhancements (<100 lines), internal refactoring

### PRD/RFC Templates

1. Copy template: `docs/prd/PRD_TEMPLATE.md` or `docs/rfc/RFC_TEMPLATE.md`
2. Rename: `PRD-NNN-feature.md` or `RFC-NNN-feature.md` (check indexes for next number)
3. Fill placeholders
4. Update index files: `docs/prd/index.md`, `docs/rfc/index.md`

### Markdown Best Practices

- Blank lines before/after lists (MD032)
- No trailing spaces (MD009)
- Tables: spaces around pipes, consistent separator (MD060)
- Code blocks: always specify language (MD040)
- No multiple blank lines (MD012)
- Heading hierarchy: H1 ‚Üí H2 ‚Üí H3 (don't skip)

### Always Update When

- `README.md` ‚Üí CLI flags, features, installation
- `docs/ARCHITECTURE.md` ‚Üí Modules, data flow, design
- `docs/api/` ‚Üí Public API changes (auto from docstrings)
- `mkdocs.yml` ‚Üí New/moved/deleted doc files (add to nav)

## üîß COMMON COMMANDS

### Development

```bash
make install-hooks    # Install pre-commit hook (one-time)
make format           # Format code (black + isort)
make lint             # Run flake8
make type             # Run mypy
make security         # Run bandit + pip-audit
```

### Testing Strategy

```bash
# Default: Start with fast tests
make test-ci-fast     # Unit + fast integration + fast e2e (~6-10 min)

# If changes touch ML code, run slow tests
make test-integration-slow  # Slow integration (~5-10 min)
make test-e2e-slow         # Slow E2E (~15-20 min)
make test-all-slow         # All slow tests

# Full CI validation before PR
make ci              # Full suite: formatting, linting, tests, docs, build
```

### Documentation

```bash
make docs            # Build docs (catches broken links)
make lint-markdown   # Check markdown files
make fix-md          # Auto-fix markdown issues
```

### Docker (conditional)

```bash
make docker-test     # ONLY if changed Dockerfile, structure, dependencies
```

## üéØ DECISION TREES

### When to Ask User

- Ambiguous requirements
- Multiple valid approaches
- Breaking changes needed
- New dependencies required
- Security implications
- Performance vs readability trade-offs

### When NOT to Ask

- Following established patterns
- Standard bug fixes
- Documentation updates
- Adding type hints (always do)
- Adding tests (always do)
- Formatting with black (always do)
- Adding docstrings (always do)

## üîç CURSOR-SPECIFIC GUIDANCE

### Model Selection

- **Auto** ‚Üí Fast iteration, small/local changes, mechanical work
- **Manual** ‚Üí Planning, debugging, architecture, complex reasoning
- Control scope: small selection ‚Üí fast model, multiple files ‚Üí stronger model
- Use reasoning language: "analyze", "root cause", "tradeoffs" ‚Üí stronger model

### Workflow Tips

- Split planning (Chat) and execution (Inline Chat)
- Use Composer for big tasks (multi-file changes)
- Reference specific sections of `.ai-coding-guidelines.md` for deep dives

## üìñ RELATED DOCUMENTATION

- `.ai-coding-guidelines.md` (2,310 lines) ‚Üí Complete AI guidelines
- `docs/guides/DEVELOPMENT_GUIDE.md` ‚Üí Technical details (code style, testing, CI/CD)
- `docs/guides/TESTING_GUIDE.md` ‚Üí Test execution, fixtures, coverage
- `docs/guides/CURSOR_AI_BEST_PRACTICES_GUIDE.md` ‚Üí Model selection strategies
- `docs/guides/MARKDOWN_LINTING_GUIDE.md` ‚Üí Markdown style rules
- `docs/ci/index.md` ‚Üí CI/CD pipeline documentation
- `docs/ARCHITECTURE.md` ‚Üí System design, module responsibilities
- `CONTRIBUTING.md` ‚Üí Human contributor guide

## ‚ö†Ô∏è REMEMBER

1. NEVER push to main (use feature branches + PRs)
2. ALWAYS show changes and get approval before commit/push
3. ALWAYS run `make ci-fast` before committing
4. Write lint-valid code from the start
5. Respect module boundaries (no mixing concerns)
6. Mock external deps in tests
7. Use Config for all runtime options
8. NEVER commit secrets
9. ALL analysis/plans ‚Üí `docs/wip/` (never `docs/analysis/`)
10. Run `make docs` before committing doc changes

When in doubt, check `.ai-coding-guidelines.md` for complete details.

---

**Version:** 1.0
**Created:** 2026-01-07
**Source:** Distilled from `.ai-coding-guidelines.md` (2,310 lines)

